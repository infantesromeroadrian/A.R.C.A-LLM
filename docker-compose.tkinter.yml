# ========================================
# A.R.C.A LLM - Docker Compose con X11
# ========================================
# Configuración para ejecutar Tkinter EN Docker (Mac/Linux)
# NOTA: Complejo en Mac, requiere XQuartz
# ========================================

services:
  # ==========================================
  # A.R.C.A - Backend API Service
  # ==========================================
  arca-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arca-backend
    restart: unless-stopped
    
    ports:
      - "8000:8000"  # API Web
    
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./src:/app/src
    
    environment:
      LM_STUDIO_URL: "http://host.docker.internal:1234/v1"
      LM_STUDIO_MODEL: "qwen/qwen3-4b-2507"
      WHISPER_MODEL: "tiny"
      LOG_LEVEL: "INFO"
    
    networks:
      - arca-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # A.R.C.A - Tkinter Frontend (⚠️ EXPERIMENTAL)
  # ==========================================
  # NOTA: Requiere X11 forwarding
  # Mac: Instalar XQuartz (https://www.xquartz.org/)
  # Linux: X11 nativo
  # ==========================================
  arca-tkinter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arca-tkinter
    restart: "no"  # No reiniciar automáticamente
    
    volumes:
      - ./src:/app/src
      # X11 socket (Linux/Mac con XQuartz)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    
    environment:
      # Display variable para X11
      DISPLAY: ${DISPLAY:-host.docker.internal:0}
      # Backend API URL
      ARCA_API_URL: "http://arca-backend:8000"
    
    networks:
      - arca-network
    
    depends_on:
      arca-backend:
        condition: service_healthy
    
    # Comando para ejecutar Tkinter
    command: python -m src.frontend_tkinter.orbe_window
    
    # IMPORTANTE: En Mac necesitas:
    # 1. Instalar XQuartz: brew install --cask xquartz
    # 2. Abrir XQuartz y habilitar "Allow connections from network clients"
    # 3. Ejecutar: xhost + localhost
    # 4. Luego: docker-compose -f docker-compose.tkinter.yml up

networks:
  arca-network:
    driver: bridge
    name: arca-network

volumes:
  models:
    driver: local
  logs:
    driver: local

